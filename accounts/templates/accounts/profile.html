{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid py-5">
  <div class="row g-4">

  <!-- LEFT SIDEBAR -->
<div class="col-lg-3 col-md-4">
  <div class="sidebar dash-card shadow p-4 text-center">

    <img src="{% if user.profile_pic %}{{ user.profile_pic.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" 
         class="rounded-circle shadow-sm mb-3" width="120" height="120" style="object-fit: cover;">

    <h4 class="fw-bold">{{ user.username }}</h4>
    <p><strong>Token: {{ user.token_id }}</strong></p>
    <p class="text-muted mb-1">{{ user.email }}</p>
    <p class="small">Joined: {{ user.date_joined|date:"F j, Y" }}</p>
    <!-- Subscription Badge -->
        {% if subscription %}
          <p class="mt-2 mb-1">
            <span class="badge bg-success fw-bold">
              ‚úÖ Subscription Active
            </span>
          </p>
          <small class="text-muted d-block">
            Plan: {{ subscription.plan.name }}<br>
            Ends: {{ subscription.end_date|date:"M d, Y" }}
          </small>
        {% else %}
          <p class="mt-2 mb-1">
            <span class="badge bg-secondary fw-bold">
              ‚ùå No Active Subscription
            </span>
          </p>
        {% endif %}
    

    {% if user.role == "doctor" %}
        <span class="badge bg-primary px-3 py-2 mb-2">Doctor</span>

        <p class="small text-primary">
          <strong>Specialization:</strong>
          {% for spec in user.specialization.all %}
              {{ spec.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
              <span class="text-muted">Not set</span>
          {% endfor %}
        </p>
        

        <hr>
        

        <!-- üîπ Doctor Practice Locations -->
        <h6 class="fw-bold text-start">Practice Locations</h6>

        {% for loc in user.doctor_locations.all %}
          <div class="card p-2 mb-2 text-start">
            <strong>{{ loc.name }}</strong><br>
            <small>üìç {{ loc.address }}</small><br>
            <small>üóì {{ loc.days }}</small><br>
            <small>‚è∞ {{ loc.start_time }} - {{ loc.end_time }}</small><br>
            <span class="badge bg-info mt-1">
              {{ loc.get_appointment_type_display }}
            </span>
          </div>
        {% empty %}
          <p class="text-muted small text-start">
            No practice locations added.
          </p>
        {% endfor %}

        <a href="{% url 'add_location' %}" 
           class="btn btn-outline-primary btn-sm w-100 mt-2">
          ‚ûï Add Location
        </a>

    {% elif user.role == "analyst" %}
        <span class="badge bg-secondary px-3 py-2 mb-2">Data Analyst</span>

    {% else %}
        <span class="badge bg-success px-3 py-2 mb-2">Patient</span>
    {% endif %}

    <hr>

    <!-- Quick Actions -->
<div class="d-grid gap-2">

  <!-- Edit Profile -->
  <a href="{% url 'edit_profile' %}" class="btn btn-warning fw-bold rounded-3 quick-btn">
    Edit Profile
  </a>

  <!-- Create Blog Post -->
  <a href="{% url 'blog_create' %}" class="btn btn-primary fw-bold rounded-3 quick-btn">
    Create Post
  </a>

  <!-- Appointment List -->
  <!-- Appointment List -->
{% if user.role == 'doctor' %}
  <a href="{% url 'doctor_my_appointment' %}"
     class="btn btn-success fw-bold rounded-3 quick-btn">
    Appointment List
  </a>

{% elif user.role == 'patient' %}
  <a href="{% url 'my_appointments' %}"
     class="btn btn-success fw-bold rounded-3 quick-btn">
    My Appointments
  </a>

{% elif user.role == 'analyst' %}
  <a href="{}"
     class="btn btn-success fw-bold rounded-3 quick-btn">
    Appointment Overview
  </a>
{% endif %}


  <!-- Patient List (Doctor Only) -->
  {% if user.role == 'doctor' %}
    <a href="{% url 'patient_lists' %}" class="btn btn-info fw-bold rounded-3 quick-btn">
      Patient List
    </a>
  {% endif %}

</div>
    <!-- Dark Mode Toggle -->
    <button id="toggleMode" class="btn btn-dark mt-3 rounded-3 w-100">
      üåô Dark Mode
    </button>

  </div>
</div>


    <!-- RIGHT CONTENT -->
    <div class="col-lg-9 col-md-8">
      <!-- Subscription Card -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm p-3">
            {% if subscription %}
              <h6 class="fw-bold text-success">‚úÖ Your Subscription is Active</h6>
              <p>Plan: {{ subscription.plan.name }}</p>
              <p>Start Date: {{ subscription.start_date|date:"M d, Y" }}</p>
              <p>End Date: {{ subscription.end_date|date:"M d, Y" }}</p>

              <!-- Remaining Days & Progress Bar -->
              <p>Subscription Remaining: {{ remaining_days }} days</p>
              <div class="progress mb-2">
                <div class="progress-bar" role="progressbar" 
                     style="width: {{ progress_percent }}%;" 
                     aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                  {{ progress_percent|floatformat:0 }}%
                </div>
              </div>

            {% else %}
              <h6 class="fw-bold text-secondary">‚ùå No Active Subscription</h6>
              <p>You currently have no active subscription.</p>
              <a href="{% url 'subscription_plans' %}" class="btn btn-primary btn-sm mt-2">View Plans</a>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card dash-card shadow p-3">
            <h6 class="text-muted">Total Posts</h6>
            <h3 class="fw-bold">{{ recent_posts.count }}</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card dash-card shadow p-3">
            <h6 class="text-muted">Comments</h6>
            <h3 class="fw-bold">{{ recent_comments.count }}</h3>
          </div>
        </div>
        {% if user.role == "doctor" %}
        <div class="col-md-4">
          <div class="card dash-card shadow p-3">
            <h6 class="text-muted">Prescriptions</h6>
            <h3 class="fw-bold">{{ recent_prescriptions.count }}</h3>
          </div>
        </div>
        {% endif %}
      </div>


      
      <!-- ================= ANALYTICS DASHBOARD ================= -->
      {% if user.role == "analyst" %}
<div class="row g-4 mb-4">

  <!-- Blog Category Analysis -->
  <div class="col-md-4">
    <div class="card dash-card shadow p-3 border-start border-4 border-primary">
      <h6 class="fw-bold text-primary">Blog Category Analysis</h6>
      <ul class="list-group list-group-flush small">
        {% for item in category_stats %}
          <li class="list-group-item d-flex justify-content-between">
            {{ item.category__name }}
            <span class="fw-bold">{{ item.total }}</span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">No data</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Urgency Level -->
  <div class="col-md-4">
    <div class="card dash-card shadow p-3 border-start border-4 border-danger">
      <h6 class="fw-bold text-danger">Urgency Level</h6>
      <ul class="list-group list-group-flush small">
        {% for item in urgency_stats %}
          <li class="list-group-item d-flex justify-content-between">
            {{ item.urgency_level|title }}
            <span class="fw-bold">{{ item.total }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Appointment Overview -->
  <div class="col-md-4">
    <div class="card dash-card shadow p-3 border-start border-4 border-success">
      <h6 class="fw-bold text-success">Appointment Overview</h6>
      <ul class="list-group list-group-flush small">
        {% for item in appointment_stats %}
          <li class="list-group-item d-flex justify-content-between">
            {{ item.status|title }}
            <span class="fw-bold">{{ item.total }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

</div>

<!-- Generated Insights -->
<div class="card dash-card shadow p-4 mb-4">
  <h5 class="fw-bold text-dark">üß† Generated Insights</h5>
  <ul class="mt-3">
    {% for insight in generated_insights %}
      <li class="mb-2">{{ insight }}</li>
    {% empty %}
      <li class="text-muted">No insights generated</li>
    {% endfor %}
  </ul>
</div>

{% endif %}

      <!-- Charts -->
      <div class="row g-3 mb-4">
        <div class="col-md-12">
          <div class="card dash-card shadow p-3">
            <h6 class="fw-bold">Posts Over Time</h6>
            <canvas id="postsChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="card dash-card shadow p-3 mb-4">
        <h6 class="fw-bold">Notifications</h6>
        <ul class="list-group list-group-flush">
          {% for note in notifications %}
          <li class="list-group-item">{{ note.text|truncatechars:50 }}</li>
          {% empty %}
          <li class="list-group-item text-muted">No new notifications</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Recent Activities -->
      <div class="card dash-card shadow mb-4">
        <div class="card-header fw-bold bg-light">Recent Activities</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for post in recent_posts %}
            <li class="list-group-item">
              <i class="bi bi-check2-circle text-success"></i>
              <strong>Posted:</strong> {{ post.title }}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No posts yet.</li>
            {% endfor %}

            {% for comment in recent_comments %}
            <li class="list-group-item">
              <i class="bi bi-chat-left-text text-primary"></i>
              <strong>Commented:</strong> {{ comment.comment_text|truncatechars:40 }}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No comments yet.</li>
            {% endfor %}

            {% if user.role == "doctor" %}
              {% for pres in recent_prescriptions %}
              <li class="list-group-item">
                <i class="bi bi-clipboard-check text-warning"></i>
                <strong>Prescribed:</strong> {{ pres.diagnosis|truncatechars:40 }}
              </li>
              {% empty %}
              <li class="list-group-item text-muted">No prescriptions yet.</li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      </div>

      {% if user.role == "doctor" %}
      <a href="{% url 'doctor_dashboard' %}" class="btn btn-primary w-100 fw-bold py-2 rounded-3 shadow-sm mb-4">
        View Patient Posts
      </a>
      {% endif %}

    </div>
  </div>
</div>

<!-- Dark Mode Script -->
<script>
const toggleBtn = document.getElementById("toggleMode");
toggleBtn.addEventListener("click", function () {
    document.body.classList.toggle("dark-mode");
    toggleBtn.textContent = 
        document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
});
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('postsChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ posts_labels|safe }},   // ['Jan', 'Feb', ...]
        datasets: [{
            label: 'Posts',
            data: {{ posts_data|safe }},   // [5, 8, 3, ...]
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            tension: 0.4
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});
</script>

{% endblock %}
